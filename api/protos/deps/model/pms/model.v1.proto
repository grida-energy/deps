syntax = "proto3";

package deps.model.pms.v1;

import "google/protobuf/timestamp.proto";

message MinMax {
  optional double min = 1;
  optional double max = 2;
}
message Point2D {
  double x = 1;
  double y = 2;
}
message LookupItemAnchor {
  optional double x = 1;
  optional double y = 2;
}
message LookupItemAxisRange {
  MinMax x = 1;
  MinMax y = 2;
}
enum LookupInputType {
  LOOKUP_INPUT_TYPE_NA = 0;
  LOOKUP_INPUT_TYPE_TIME_SEC = 1;
  LOOKUP_INPUT_TYPE_TIME_MIN = 2;
  LOOKUP_INPUT_TYPE_TIME_HOUR = 3;
  LOOKUP_INPUT_TYPE_TIME_SEC_SINCE_SEQUENCE = 4;
  LOOKUP_INPUT_TYPE_TIME_SEC_SINCE_CHAIN = 5;
  LOOKUP_INPUT_TYPE_SOC = 6;
  LOOKUP_INPUT_TYPE_SOC_PU = 7;
  LOOKUP_INPUT_TYPE_TMP = 8;
  LOOKUP_INPUT_TYPE_PRICE = 9;
  LOOKUP_INPUT_TYPE_W_SRC = 10;
  LOOKUP_INPUT_TYPE_W_CUT = 11;
}
enum LookupOutputType {
  LOOKUP_OUTPUT_TYPE_NA = 0;
  LOOKUP_OUTPUT_TYPE_W_CMD = 1;
  LOOKUP_OUTPUT_TYPE_W_ABS = 2;
  LOOKUP_OUTPUT_TYPE_W_MAX_POS = 3;
  LOOKUP_OUTPUT_TYPE_W_MAX_NEG = 4;
  LOOKUP_OUTPUT_TYPE_VA_CMD = 5;
}
enum OutputBlendMode {
  OUTPUT_BLEND_MODE_OVERRIDE = 0;
  OUTPUT_BLEND_MODE_CLAMP_ZERO = 1;
  OUTPUT_BLEND_MODE_ADDITION = 2;
  OUTPUT_BLEND_MODE_SUBTRACT = 3;
  OUTPUT_BLEND_MODE_MULTIPLY = 4;
  OUTPUT_BLEND_MODE_MUL_MASK_ZPOS = 5;
  OUTPUT_BLEND_MODE_OVERRIDE_SOME = 6;
}
message ChartFn { repeated Point2D points = 1; }
message ChainFn { repeated ChartFn charts = 1; }
message LookupComplete {
  repeated Point2D ranges = 1;
  double win_tms = 2;
}

message LookupItem {
  LookupItemAnchor anchor = 1;
  repeated LookupItemAxisRange axis_range = 2;
  LookupInputType in_type = 3;
  LookupOutputType out_type = 4;
  ChainFn chain_fn = 5;
  OutputBlendMode blend_mode = 6;
  double win_tms = 7;
  double rmp_tms = 8;
  LookupComplete complete = 9;
}

message LookupSequenceState {
  repeated LookupItemAnchor io_snapshot = 1;
  repeated bool completed = 2;
  .google.protobuf.Timestamp stamp_complete_check = 3;
  .google.protobuf.Timestamp stamp_sequence_enter = 4;
  .google.protobuf.Timestamp stamp_chain_enter = 5;
  string error = 6;
}
message LookupSequence {
  bool ena = 1;
  string name = 2;
  repeated LookupItem sequence = 3;
  LookupSequenceState state = 4;
}

message LookupInput {
  .google.protobuf.Timestamp stamp = 1;
  optional double soc = 2;
  optional double tmp = 3;
  optional double price = 4;
  optional double w_src = 5;
  optional double w_cut = 6;
}
message LookupOutput {
  optional double w_cmd = 1;
  optional double w_max_pos = 2;
  optional double w_max_neg = 3;
  optional double va_abs = 4;
}

message LookupRule {
  enum St {
    ST_NA = 0;
  }
  message Fault { bool other = 1; }
  message Warning { bool other = 1; }
  message Status { bool other = 1; }
  // enum Ena {
  //   ENA_NA = 0;
  //   ENA_DISABLE = 1;
  //   ENA_ENABLE = 2;
  // }
  message Command {
    message EnaRule {
      string name = 1;
      bool ena = 2;
    }
    message AddRule {
      string name = 1;
      repeated LookupItem items = 2;
      bool upsert = 3;
    }
    message DeleteRule { string name = 1; }
    message ClearRules {}
    message OverwriteRules { repeated LookupSequence rules = 1; }

    oneof rule {
      bool ena = 1;
      EnaRule ena_rule = 2;
      AddRule add = 3;
      DeleteRule delete = 4;
      ClearRules clear = 5;
      OverwriteRules overwrite = 6;
    }
  }

  bool ena = 1;
  repeated LookupSequence rules = 2;
  repeated LookupSequence forced = 3;
}